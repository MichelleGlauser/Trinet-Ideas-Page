<!-- Goal: make a div with the top users in the Trinet community using this API: https://getsatisfaction.com/corp/help/api-resources/ -->




<!-- Head Tag  -->

<div class="mini-survey leaderboard-container">  
  <div class="top">
    <h3>Our Top Users</h3>
      <ul class="top-users"
    </ul>
  </div>
</div>




<script type='text/javascript'>
    var companyName = 'trinet';
    var timeStamp = 0;


    jQuery(function () {
        

        var obj;
        var today = new Date();
        var lastWeek = new Date(today.getTime() - 1000 * 60 * 60 * 24 * 7);
        var timeStamp = lastWeek.getTime() / 1000;

        jQuery.ajax({
            type: 'GET',
            url: 'https://api.getsatisfaction.com/companies/' + companyName +
                '/topics.json?sort=recently_active&limit=30&active_since=' +
                timeStamp,
            dataType: 'jsonp',
            success: function(results) {
                processAllTopics(results);
            }
        });
    });

    var people = new Array();
    var processedPages = 0;
    var repliesToBeHandled = 0;
    var totalPages = 0;

    function processAllTopics(results) { 
        var obj;
        if (results.total > 0) {
            var htmlToAdd = '';
            totalPages = results.total / 30;
            for (var pageNum = 0; pageNum < totalPages; pageNum++) {
                jQuery.ajax({
                    type: 'GET',
                    url: 'https://api.getsatisfaction.com/companies/' + companyName +
                        '/topics.json?sort=recently_active&active_since=' +
                        timeStamp + '&limit=30&page=' + (pageNum + 1),
                    dataType: 'jsonp',
                    success: function(results) {
                        processEachTopic(results); 
                    }
                }); 
            }
        } 
    };

    function processEachTopic(results) {
        if (results.data.length > 0) {
            for (var i = 0; i < results.data.length; i++) {
                if (results.data[i].active_replies > 0) {
                    jQuery.ajax({
                        type: 'GET',
                        url: results.data[i].url +
                            '/replies.json',
                        dataType: 'jsonp',
                        success: function(results) {
                            processEachTopicReplies(results);
                              repliesToBeHandled++;
                        }
                    });
                } 
            }
        }
        processedPages++;
    }                

    function processEachTopicReplies(results) {
        if (results.data.length > 0) {
            for (var i = 0; i < results.data.length; i++) {
                var ts = new Date(results.data[i].created_at);
                if ((!results.data[i].author.employee) && (ts.getTime() /
                    1000 > timeStamp)) {
                    peopleIdx = isInArray(results.data[i].author.canonical_name)
                    // if author is already in people[] array, increment the number of activity 
                    if (peopleIdx >= 0) {
                        people[peopleIdx][0]++;
                    } 
                    else {
                        // add new element to array, and initialize the number of activities to 1 
                        people[people.length] = [1, results.data[i].author.canonical_name,
                            results.data[i].author.at_sfn, results.data[i].author
                            .name];
                    }
                }
            }
        }
        repliesToBeHandled--;
        if ((processedPages >= totalPages - 1) && (repliesToBeHandled <= 0)) {
            var htmlToAdd = '';
            people.sort(compareTotals);
            people.remove(0);
            var peopleLimit = people.length;
            if (peopleLimit > 10) {
                peopleLimit = 10;
            }
            for (var i = 0; i < peopleLimit; i++) {
                htmlToAdd = htmlToAdd + '<span="numReplies">' + people[i]
                [0] + '</span><li class="peopleLink"><a href="' + people[i]
                [2] + '">' + people[i][3] + '</a></li>';
            }
            jQuery('#ul.top-users').html(htmlToAdd);
            console.log(htmlToAdd);
        }
    }

        // returns the Index of the person in the people[] array, or - 1
        // if the person is not in the array

    function isInArray(name) {
        for (var i = 0; i < people.length; i++) {
            if (people[i][1] == name) {
                return i;
            }
        }
        return -1;
    }

    function compareTotals(a, b) {
        return b[0] - a[0];
    }

    Array.prototype.remove = function (from, to) {
        var rest = this.slice((to || from) + 1 || this.length);
        this.length = from < 0 ? this.length + from : from;
        return this.push.apply(this, rest);
    };
</script>